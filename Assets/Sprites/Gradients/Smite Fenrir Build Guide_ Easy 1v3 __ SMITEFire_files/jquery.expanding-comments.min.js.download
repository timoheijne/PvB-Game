jQuery.fn.expandingComments=function(e){var t=this,n={user_is_prime:t.hasClass("user-is-prime")},r=(e=$.extend({},n,e),{insert:".spotForForm",data:"script[type='text/data']",preview:".comments-preview"}),o={reply:t.nextAll("#replyForm").html(),delete:t.nextAll("#deleteForm").html()},i={open:{symbol:"[-]",text:"Collapse All Comments"},closed:{symbol:"[+]",text:"Expand All Comments"}},a="/ajax/edit-comment",s=e.user_is_prime,l={vote:!1};function c(e){var t=$(e.currentTarget).parents("form");t.find(":input[name='action']").val("validate/preview"),t.submit()}function m(e){e.preventDefault();var t=$(e.currentTarget).parents(".comment:first"),n=t.children(r.insert),i=$(t.children(r.data).html());return t.children("form").length||(t.children("form").remove(),h(o.reply,n,i,"reply")),!1}function d(e){e.preventDefault();var t,n,i,a,s,l=$(e.currentTarget).parents(".comment:first"),c=l.children(r.insert),m=$(l.children(r.data).html());return m.append($("<span />",{id:"comment_text",text:"[quote="+$("#username",m).text()+"]"+$("#bbcode",m).text()+"[/quote]\n"})),l.children("form").length?(t=l.children("form").eq(0),n=m,a=t.find("textarea"),s=a.val(),$.each($("span",n),function(e,t){var n=$(t);i=n.text()}),a.val(s+i)):h(o.reply,c,m,"quote"),!1}function u(e){e.preventDefault();var t=$(e.currentTarget).parents(".comment:first"),n=t.children(r.insert),i=$(t.children(r.data).html());return i.append($("<span />",{id:"comment_text",text:$("#bbcode",i).text()})),t.children("form").length&&t.children("form").remove(),h(o.reply,n,i,"edit"),!1}function p(e){e.preventDefault();var t=$(e.currentTarget),n=t.parents(".comment:first"),i=n.children(r.insert),a=$(n.children(r.data).html()),s=t.find("a").text().toLowerCase();return confirm("Are you sure you want to "+s+" this comment?")&&(n.children("form").length&&n.children("form").remove(),h(o.delete,i,a,"delete")),!1}function f(e,t){e.preventDefault();var n=$(t.target),r=$(e.currentTarget);switch(t.toggle){case 0:r.toggleClass("minified"),n.text()==i.open.symbol?n.text(i.closed.symbol):n.text(i.open.symbol);break;case-1:r.addClass("minified"),n.text(i.closed.symbol);break;case 1:r.removeClass("minified"),n.text(i.open.symbol)}return!1}function g(e,n){e.preventDefault();var r=$(n.target),o=t.children(".comments");return $.each(o.children(".comment"),function(e,t){var n=$(t);n.trigger("comment.toggle",{target:n.find(".expand").get(0),toggle:r.text()==i.open.symbol?-1:1})}),r.text()==i.open.symbol?(r.text(i.closed.symbol),r.next().text(i.closed.text)):(r.text(i.open.symbol),r.next().text(i.open.text)),!1}function v(e,t){if(e.preventDefault(),l.vote)return!1;var n=$(t.target),o=n.parents(".comment:first"),i=$(o.children(r.data).html()),s={action:"vote",relation_type:"Comment",relation_id:$("#comment_id",i).text(),score:t.change};return l.vote=!0,$.post(a,s,function(e){if(e.success){var t=parseInt(n.siblings("span").text());n.hasClass("selected")?n.siblings().andSelf().removeClass("selected"):(n.siblings().andSelf().removeClass("selected"),n.addClass("selected")),n.siblings("span").text(t+e.diff)}else alert(e.message)},"json").always(function(){l.vote=!1}),!1}function h(e,t,n,r){var o=$(e);$.each($("span",n),function(e,t){var n=$(t);o.find(":input[name='"+n.attr("id")+"']").val(n.text())}),o.find(".markItUp").markItUp(mySettings),"edit"==r&&(o.find(":submit").text("Edit Comment"),o.find(":input[name='action']").val("validate/edit")),o.on("submit",x).on("reset",b),$(o).insertAfter(t),"delete"==r&&o.submit()}function x(e){e.preventDefault();var n=$(e.currentTarget),o=n.find(":input[name='action']"),i=o.val().split("/");switch(n.attr("action",a),n.find("button").prop("disabled",!0),o.val(i[0]),i[0]){case"validate":$.post(a,n.serialize(),function(e){if(e.success)switch(i[1]){case"preview":o.val(i[1]),$.post(a,n.serialize(),function(e){e.success?(t.find(r.preview).empty().append($("<div />").html(e.preview).children()),i[1]="reply",o.val(i.join("/"))):(alert(e.message),o.val(i.join("/")))},"json").always(function(){n.find("button").prop("disabled",!1)});break;default:n.off("submit",x),o.val(i[1]),n.submit()}else alert(e.message),o.val(i.join("/")),n.find("button").prop("disabled",!1)},"json");break;default:n.off("submit",x),n.submit()}return!1}function b(e){return e.preventDefault(),$(e.currentTarget).remove(),!1}function y(e){e.preventDefault();var t=$(e.currentTarget);return t.parent().find(".collapsed").removeClass("collapsed"),t.remove(),!1}function w(e,t){if(e.preventDefault(),!s)return!1;var n=$(t.target),o=$(e.currentTarget),l={action:"prime:state",comment_id:$(o.children(r.data).html()).children("#comment_id").text(),state:0};switch(t.toggle){case 0:n.text()==i.open.symbol&&(l.state=1),$.post(a,l,function(e){},"json")}return!1}!function(){if($(".comment",t).on("comment.toggle",f).on("click",".expand",function(){return $(this).closest(".comment").trigger("comment.toggle",{target:$(this).get(0),toggle:0}),!1}),$(".actions",t).on("comments.toggle",g).on("click",".expand",function(){var e=$(this);return e.text()==i.open.symbol?$(this).closest(".actions").trigger("comments.toggle",{target:e.get(0),toggle:1}):$(this).closest(".actions").trigger("comments.toggle",{target:e.get(0),toggle:-1}),!1}),$(".load-more",t),$(document).on("click",".load-more",y),$(".vote",t),$(document).on("vote.change",".vote",v),$(document).on("click",".up",function(){return $(this).closest(".vote").trigger("vote.change",{target:$(this).get(0),change:1}),!1}),$(document).on("click",".down",function(){return $(this).closest(".vote").trigger("vote.change",{target:$(this).get(0),change:-1}),!1}),t.hasClass("not-logged-in"))return!1;if($(".comment",t),$(document).on("click",".reply",m),$(document).on("click",".quote",d),$(document).on("click",".edit",u),$(document).on("click",".delete",p),$("#new-comment-form",t).on("click",".preview",c).on("submit",x).on("reset",b),!s)return!1;$(".comment",t).on("comment.state",w).on("click",".expand",function(){return $(this).closest(".comment").trigger("comment.state",{target:$(this).get(0),toggle:0}),!1})}(),function(){var e=window.location.hash.slice(1),n=$("a.anchor[name='"+e+"']",t).parent(".comment");if(n.length&&n.hasClass("collapsed")){var r=n.parents(".comment:not(.collapsed):first");r.children(".load-more").click()}n.length&&n.parents(".minified").removeClass("minified")}()};